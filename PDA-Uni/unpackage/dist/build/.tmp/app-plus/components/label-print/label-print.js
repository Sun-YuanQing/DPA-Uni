(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["components/label-print/label-print"],{"4a4d":function(module,exports,__webpack_require__){"use strict";(function(uni){Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _apiService=_interopRequireDefault(__webpack_require__("2e17")),_consts=_interopRequireDefault(__webpack_require__("f2a9")),_storage=_interopRequireDefault(__webpack_require__("00e0")),_util=_interopRequireDefault(__webpack_require__("409c")),_bluetoothPrint=_interopRequireDefault(__webpack_require__("f342"));function _interopRequireDefault(t){return t&&t.__esModule?t:{default:t}}var barcodeInput=function(){return __webpack_require__.e("components/barcode-input/barcode-input").then(__webpack_require__.bind(null,"d7ce"))},uniPopupModal=function(){return __webpack_require__.e("components/uni-popup-modal/uni-popup-modal").then(__webpack_require__.bind(null,"b32a"))},uniPopup=function(){return __webpack_require__.e("components/uni-popup/uni-popup").then(__webpack_require__.bind(null,"4f86"))},_default2={name:"label-print",components:{uniPopupModal:uniPopupModal,uniPopup:uniPopup,barcodeInput:barcodeInput},data:function(){(new Date).getTimestamp();return{show:!1,showReportList:!1,showPrinterList:!1,printerList:[],reportList:[],selReportList:[],showScanTag:!1,isSaveSelected:!1,scanTagModelList:[]}},props:{progNo:{type:String,required:!0},reportModel:{type:[Object],required:!0,default:function(){return{isMultiPrint:!1,dataSource:Array,isNeedValidTag:!1}},validator:function(t){var e=t.dataSource instanceof Array;if(!e)throw"标签数据源请传数组格式";return e}},isShowSaveSelected:{type:Boolean,default:!0},showReport:{type:Boolean,required:!0,default:!1}},watch:{showReport:{immediate:!0,handler:function(t){if(this.show=t,this.show){var e=this.reportModel.dataSource instanceof Array;if(!e)throw uni.showToast({title:"标签数据源请传数组格式",icon:"none"}),"标签数据源请传数组格式";this.onPrint()}}}},onReady:function(){this.isSaveSelected=!1},methods:{onPrint:function(){0==this.reportList.length?this.refreshReport():this.showReportList=!0},refreshReport:function(){var t=this;uni.showLoading({mask:!0}),_apiService.default.getReportList({data:{progNo:this.progNo,includePrintSyntax:!1},success:function(e){t.reportList=e,t.showReportList=!0},complete:function(t,e,i){_util.default.tryCatchApi({status:t,message:e}),uni.hideLoading()}})},togglePopup:function(t){switch(t){case"showReportList":this.showReportList=!1;break;case"showPrinterList":this.showPrinterList=!1;break}this.show=!1,this.$emit("printCancel")},checkboxChange:function(t){for(var e=this.reportList,i=t.detail.value,r=0,a=e.length;r<a;++r){var n=e[r];i.includes(n.controlName)?this.$set(n,"checked",!0):this.$set(n,"checked",!1)}},onReportSelected:function(t){var e=this,i="";if(this.reportModel.isMultiPrint){for(var r=0;r<this.reportList.length;r++)this.reportList[r].checked&&(i+=this.reportList[r].controlName+",");if(0==i.length)return void uni.showToast({title:"请勾选要打印的标签",icon:"none"})}else i+=this.reportList[t].controlName+",";i=i.substr(0,i.length-1),uni.showLoading({title:"正在加载数据..."}),_apiService.default.getReportList({data:{progNo:this.progNo,controlName:i,includePrintSyntax:!0},success:function(t){e.selReportList=t,e.refreshPrinter(),e.showReportList=!1,e.showPrinterList=!0},complete:function(t,e,i){_util.default.tryCatchApi({status:t,message:e}),uni.hideLoading()}})},refreshPrinter:function(){var t=this;t.printerList=[],uni.showLoading({mask:!0});var e=_storage.default.get(_consts.default.storageKeys.usedLabelAndPrinters)||[],i=!1,r=_storage.default.get(_consts.default.storageKeys.bluetoothPrinterSet);void 0==r&&(r={enableBluetooth:!1,deviceId:"",deviceName:""}),r.enableBluetooth&&_bluetoothPrint.default.searchPrinter({success:function(a){for(var n=0;n<a.length;n++){var o=a[n];if(!(r.deviceId.length>0&&r.deviceId!=o.deviceId)){var l={PrinterName:o.deviceId,DeviceName:o.name,printerType:1};i=t.isExistPrinterItem(e,o.deviceId),i?t.printerList.insert(0,l):t.printerList.add(l)}}}}),_apiService.default.getPrinterList({success:function(r){for(var a=0;a<r.length;a++){var n=r[a];if(n.printerType="0",!(n.WorkOffLine||n.PrinterName.indexOf("Microsoft")>-1))if(i)t.printerList.push(n);else{var o=t.isExistPrinterItem(e,n.PrinterName);o?t.printerList.insert(0,n):n.IsDefault?t.printerList.insert(0,n):t.printerList.push(n)}}},complete:function(t,e,i){_util.default.tryCatchApi({status:t,message:e}),uni.hideLoading()}})},isExistPrinterItem:function(t,e){for(var i=!1,r=0;r<t.length;r++)if(t[r].progNo==this.progNo&&t[r].printerName==e){i=!0;break}return i},cbxChange:function(){this.isSaveSelected=!this.isSaveSelected},onPrinterSelected:function(t){for(var e=this,i=this.printerList[t],r=_storage.default.get(_consts.default.storageKeys.usedLabelAndPrinters)||[],a=0;a<r.length;a++)if(r[a].progNo==this.progNo){r.remove(r[a]);break}var n=_util.default.clone(this.selReportList);for(a=0;a<n.length;a++)n[a].reportSyntax="";var o={progNo:this.progNo,labels:n,printerName:i.PrinterName,deviceName:0==i.printerType?"":i.DeviceName,printerType:i.printerType,isUserDefault:this.isSaveSelected};r.push(o),_storage.default.set(_consts.default.storageKeys.usedLabelAndPrinters,r),e.onPrinterSelectedSub(o,!1)},onPrinterSelectedSub:function(t,e){var i=this;if(0==t.printerType){for(var r="",a=0;a<this.selReportList.length;a++){var n=this.selReportList[a];r+=n.controlName+","}r=r.substr(0,r.length-1),this.onServerPrint(r,t.printerName)}else e?(uni.showLoading({title:"正在搜索蓝牙"}),_bluetoothPrint.default.searchPrinter({success:function(e){for(var r=!1,a=0;a<e.length;a++)if(e[a].deviceId==t.printerName){r=!0;break}console.log("isFindDevice:"+r," at components\\label-print\\label-print.vue:434"),uni.hideLoading(),r?i.onExecBluetoothPrint(t):uni.showToast({title:"没有找到蓝牙，请重试！",icon:"none"})},fail:function(){uni.hideLoading(),uni.showToast({title:"没有找到蓝牙，请重启PDA蓝牙重试！",icon:"none"})}})):i.onExecBluetoothPrint(t)},onExecBluetoothPrint:function(t){for(var e=this,i=[],r=0;r<e.selReportList.length;r++)for(var a=e.selReportList[r],n=e.jxXml(a.reportSyntax),o=0;o<e.reportModel.dataSource.length;o++){var l=e.reportModel.dataSource[o];i.push({jxXmlObj:n,dataItem:l})}_bluetoothPrint.default.connect({data:{deviceId:t.printerName},success:function(){e.onBluetoothPrint(i,0)},fail:function(){uni.showToast({title:"蓝牙连接失败",icon:"none"})}})},onServerPrint:function(t,e){var i=this;uni.showLoading({title:"服务器正在打印",mask:!0}),_apiService.default.printReport({data:{reportId:t,printerName:e,dataSource:JSON.stringify(this.reportModel.dataSource)},success:function(t){uni.showToast({title:"打印成功"}),i.showPrinterList=!1,i.reportModel.isNeedValidTag?(i.showScanTag=!0,i.$refs.input_scan.clear(),i.$refs.input_scan.setFocus()):i.$emit("printComplete")},complete:function(t,e,i){_util.default.tryCatchApi({status:t,message:e}),uni.hideLoading()}})},onBluetoothPrint:function onBluetoothPrint(labelList,index){var reportTag=labelList[index].jxXmlObj,dataItem=labelList[index].dataItem,that=this;_bluetoothPrint.default.initCommand();var bluetoothPrinterSet=_storage.default.get(_consts.default.storageKeys.bluetoothPrinterSet),portrait=!0;bluetoothPrinterSet.enableBluetooth&&(portrait=void 0==bluetoothPrinterSet.portrait||bluetoothPrinterSet.portrait),portrait?_bluetoothPrint.default.addSize(reportTag.pageWidth,reportTag.pageHeight):_bluetoothPrint.default.addSize(reportTag.pageHeight,reportTag.pageWidth),_bluetoothPrint.default.addGap(3),_bluetoothPrint.default.addCls();for(var i=0;i<reportTag.bandsArr.length;i++){var item=reportTag.bandsArr[i],value=this.getControlValue(reportTag,item,dataItem);switch(this.getLocationFloat(portrait,item.locationFloat,reportTag.pageWidth,reportTag.pageHeight),reportTag.bandsArr[i].controlType){case"XRLabel":console.log("item: "+JSON.stringify(item)," at components\\label-print\\label-print.vue:566"),_bluetoothPrint.default.addText(item.locationFloat.x,item.locationFloat.y,value,item.font.fontSize,item.font.bold,item.font.underline,portrait);break;case"XRBarCode":"QRCode"==item.codeType?_bluetoothPrint.default.addQR(item.locationFloat.x,item.locationFloat.y,value,item.module,portrait):_bluetoothPrint.default.addBarcode(item.locationFloat.x,item.locationFloat.y,value,item.codeType,item.sizeF[1],item.showText,portrait,item.module);break;case"XRPictureBox":break;default:break}}_bluetoothPrint.default.addPagePrint({data:{title:"正在打印第 "+eval(index+1)+" 张"},success:function(t){index++,index<labelList.length?setTimeout(function(){that.onBluetoothPrint(labelList,index)},250):(_bluetoothPrint.default.disconnect(),that.showPrinterList=!1,that.reportModel.isNeedValidTag?(that.show=!0,that.showScanTag=!0,that.$refs.input_scan.setFocus()):that.$emit("printComplete"))},fail:function(){uni.showToast({title:"蓝牙打印失败请重试",icon:"none"}),_bluetoothPrint.default.disconnect()}})},onTagScaned:function(t){var e=this;uni.showLoading({mask:!0}),_apiService.default.basic_QRCodeAnalysis({data:{qrCode:t},success:function(i){for(var r=!1,a=0;a<e.reportModel.dataSource.length;a++)if(e.reportModel.dataSource[a].tagId==i.tagId){r=!0;break}r?(i.qrCode=t,e.scanTagModelList.push(i),e.$refs.input_scan.clear(),uni.showToast({title:"校验成功"}),_util.default.showScanedAudio()):uni.showToast({title:"标签扫描错误！",icon:"none"})},failure:function(t){_util.default.showAudio()},complete:function(t,i,r){e.$refs.input_scan.setFocus(),_util.default.tryCatchApi({status:t,message:i}),uni.hideLoading()}})},onTagScanSave:function(){if(0==this.scanTagModelList.length)return this.$refs.input_scan.setFocus(),void uni.showToast({title:"请先完成扫描校验",icon:"none"});this.$emit("tagValid",this.scanTagModelList),this.scanTagModelList=[],this.showScanTag=!1,this.show=!1},jxXml:function(t){var e=__webpack_require__("6925").DOMParser,i=(new e).parseFromString(t,"text/xml"),r=i.documentElement,a=r.getAttribute("Dpi")||100,n=r.getAttribute("ReportUnit"),o=this.convertUnit2MM(n,a,r.getAttribute("PageWidth")),l=this.convertUnit2MM(n,a,r.getAttribute("PageHeight")),s=this.getCalculatedFields(i),u=this.getBands(i,n,a),d={pageWidth:o,pageHeight:l,reportUnit:n,dpi:a,calcArr:s,bandsArr:u};return d},convertUnit2MM:function(t,e,i){var r=25.4;switch(t){case"TenthsOfAMillimeter":i=_util.default.floatObj.divide(i,10);break;case"Pixels":i=_util.default.floatObj.multiply(_util.default.floatObj.divide(i,e),r);break;default:i=_util.default.floatObj.multiply(_util.default.floatObj.divide(i,100),r);break}return parseInt(i)},convertUnit2PX:function(t,e,i){console.log("val: "+i+" dpi:"+e," at components\\label-print\\label-print.vue:754");var r=25.4;switch(t){case"TenthsOfAMillimeter":i=_util.default.floatObj.multiply(_util.default.floatObj.divide(_util.default.floatObj.divide(i,10),r)*e),console.log(i," at components\\label-print\\label-print.vue:760");break;case"Pixels":break;default:i=_util.default.floatObj.multiply(_util.default.floatObj.divide(i,100),e);break}return i},convertMM2Dot:function(t,e,i){return parseInt(8*this.convertUnit2MM(t,e,i))},getCalculatedFields:function(t){var e=[],i=t.getElementsByTagName("CalculatedFields");if(0==i.length)return e;for(var r=i[0].childNodes,a=0;a<r.length;a++)if("#text"!=r[a].nodeName){var n=r[a].getAttribute("Name"),o=r[a].getAttribute("Expression");e.push({id:n,value:o})}return e},getBands:function(t,e,i){var r=[],a=t.getElementsByTagName("Bands");if(0==a.length)return r;for(var n=a[0].childNodes,o=0;o<n.length;o++)if("#text"!=n[o].nodeName)for(var l=0;l<n[o].childNodes.length;l++)if("#text"!=n[o].childNodes[l].nodeName&&"Controls"==n[o].childNodes[l].tagName)for(var s=0;s<n[o].childNodes[l].childNodes.length;s++){var u=n[o].childNodes[l].childNodes[s];if("#text"!=u.nodeName){var d=u.getAttribute("ControlType"),c=null;if(u.getElementsByTagName("DataBindings").length>0){var p=u.getElementsByTagName("DataBindings")[0].childNodes[1];c={dataMember:p.getAttribute("DataMember"),formatString:p.getAttribute("FormatString")}}var h=u.getAttribute("Padding").split(","),f=h[0]>0?2*h[0]:0,g=u.getAttribute("LocationFloat").split(","),b=_util.default.floatObj.add(g[0],f),m={x:this.convertMM2Dot(e,i,b),y:this.convertMM2Dot(e,i,g[1])},v=u.getAttribute("SizeF").split(",");switch(v[0]=this.convertMM2Dot(e,i,v[0]),v[1]=this.convertMM2Dot(e,i,v[1]),d){case"XRLabel":var _=!1,P=!1,S=!1,w=u.getAttribute("Font"),L=w.split(","),y=w.indexOf("=")+1;if(y>-1)for(var x=w.substring(y),k=x.split(","),N=0;N<k.length;N++)"Bold"==k[N].trim()?_=!0:"Italic"==k[N].trim()?P=!0:"Underline"==k[N].trim()&&(S=!0);var T={controlType:d,text:u.getAttribute("Text"),dataBindings:c,sizeF:v,locationFloat:m,font:{family:L.length>0?L[0]:"",fontSize:L.length>1?Number(L[1].replace("pt","").trim()):"",bold:_,italic:P,underline:S},padding:h};r.push(T);break;case"XRBarCode":var A=u.getElementsByTagName("Symbology")[0].getAttribute("Name");T={controlType:d,module:0==u.getAttribute("Module").length?2:u.getAttribute("Module"),alignment:u.getAttribute("Alignment"),showText:u.getAttribute("ShowText"),sizeF:v,locationFloat:m,padding:h,text:u.getAttribute("Text"),dataBindings:c,codeType:A},r.push(T);break;case"XRPictureBox":break;case"XRLine":T={controlType:d,lineWidth:u.getAttribute("LineWidth"),sizeF:v,locationFloat:m},r.push(T);break;default:break}}}return r},getLocationFloat:function(t,e,i,r){if(!t){var a=e.x,n=e.y;e.x=n,e.y=8*i-a}},getControlValue:function(t,e,i){var r="";switch(e.controlType){case"XRLabel":r=e.text.length>0?e.text:this.getExpressionValue(t,e,i);break;case"XRBarCode":r=e.text.length>0?e.text:this.getExpressionValue(t,e,i);break;case"XRPictureBox":break;default:break}return r},autoResizeImage:function(t,e,i,r){var a=1,n=t/i,o=e/r;return 0==t&&0==e?a=1:0==t?o<1&&(a=o):0==e?n<1&&(a=n):(n<1||o<1)&&(a=n<=o?n:o),a<1&&(i*=a,r*=a),{width:parseInt(i),height:parseInt(r)}},getAlignmentOffset:function(t){},getExpressionValue:function getExpressionValue(jxXmlObj,item,dataItem){for(var calsStr="",i=0;i<jxXmlObj.calcArr.length;i++)if(jxXmlObj.calcArr[i].id==item.dataBindings.dataMember){calsStr=jxXmlObj.calcArr[i].value;break}if(calsStr.length>0){for(var rlt=calsStr.match(/\[\w+\]/g),_i=0;_i<rlt.length;_i++){var key=rlt[_i].match(/(\w+)/g)[0];key=key.replace(key[0],key[0].toLowerCase());var value=dataItem[key];void 0==value&&(value=""),calsStr=calsStr.replace(rlt[_i],"'"+value+"'")}return eval(calsStr)}var key=item.dataBindings.dataMember;key=key.replace(key[0],key[0].toLowerCase());var value=dataItem[key];if(void 0==value&&(value=""),void 0!==item.dataBindings.formatString&&item.dataBindings.formatString.length>0){var content=item.dataBindings.formatString.match(/{0(:)?(\S)*}/g)[0],arrSplit=content.split(":");if(arrSplit.length>1){var format=arrSplit[1].substr(0,arrSplit[1].length-1);format.indexOf("#")>-1?value=Number(value):format.indexOf("yy")>-1&&(value=value.replace(new RegExp(/-/gm),"/"),value=new Date(value).format(format))}value=item.dataBindings.formatString.replace(content,value)}return value},userDefaultPrint:function(){for(var t=this,e=_storage.default.get(_consts.default.storageKeys.usedLabelAndPrinters)||[],i=null,r=0;r<e.length;r++)if(e[r].progNo==this.progNo){i=e[r];break}if(null!=i){console.log(i," at components\\label-print\\label-print.vue:1142");for(var a="",n=0;n<i.labels.length;n++){var o=i.labels[n];a+=o.controlName+","}return a=a.substr(0,a.length-1),uni.showLoading({title:"正在加载数据",mask:!0}),_apiService.default.getReportList({data:{progNo:this.progNo,controlName:a,includePrintSyntax:!0},success:function(e){t.selReportList=e,t.onPrinterSelectedSub(i,!0)},complete:function(t,e,i){_util.default.tryCatchApi({status:t,message:e}),uni.hideLoading()}}),i}uni.showToast({title:"没有默认配置",icon:"none"})},checkUseDefaultPrint:function(){for(var t=_storage.default.get(_consts.default.storageKeys.usedLabelAndPrinters)||[],e=!1,i=0;i<t.length;i++)if(t[i].progNo==this.progNo&&t[i].isUserDefault){e=!0;break}return e}}};exports.default=_default2}).call(this,__webpack_require__("6e42")["default"])},"57e1":function(t,e,i){"use strict";var r=function(){var t=this,e=t.$createElement;t._self._c},a=[];i.d(e,"a",function(){return r}),i.d(e,"b",function(){return a})},"59ca":function(t,e,i){"use strict";var r=i("cebf"),a=i.n(r);a.a},"831b":function(t,e,i){"use strict";i.r(e);var r=i("57e1"),a=i("b9fd");for(var n in a)"default"!==n&&function(t){i.d(e,t,function(){return a[t]})}(n);i("59ca");var o=i("2877"),l=Object(o["a"])(a["default"],r["a"],r["b"],!1,null,null,null);e["default"]=l.exports},b9fd:function(t,e,i){"use strict";i.r(e);var r=i("4a4d"),a=i.n(r);for(var n in r)"default"!==n&&function(t){i.d(e,t,function(){return r[t]})}(n);e["default"]=a.a},cebf:function(t,e,i){}}]);
;(global["webpackJsonp"] = global["webpackJsonp"] || []).push([
    'components/label-print/label-print-create-component',
    {
        'components/label-print/label-print-create-component':(function(module, exports, __webpack_require__){
            __webpack_require__('6e42')['createComponent'](__webpack_require__("831b"))
        })
    },
    [['components/label-print/label-print-create-component']]
]);                
